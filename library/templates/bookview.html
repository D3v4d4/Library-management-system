{% extends 'navigation.html' %}
{% load static %}

{% block title %}Manage Books | Library Management System{% endblock %}

{% block body %}
<style>
  .card-shell{ border:0; border-radius:18px; box-shadow:0 12px 30px rgba(2,6,23,.10); overflow:hidden; background:#fff; }
  .card-header-brand{
    background: linear-gradient(90deg, var(--brand-bg, #0f172a), #111827);
    color:#fff; padding:16px 20px;
  }
  .search-wrap .input-group-text{ background:#f3f4f6; }
  .search-wrap .form-control, .search-wrap .input-group-text{ border-radius:10px; }
  .table thead th{ white-space:nowrap; }
  /* Fallback if .btn-brand not defined in base */
  .btn-brand{
    --bs-btn-padding-x:.8rem; --bs-btn-padding-y:.45rem; --bs-btn-font-weight:600; --bs-btn-border-radius:999px;
    --bs-btn-color:#fff; --bs-btn-bg: var(--brand-primary,#0ea5a4); --bs-btn-border-color: var(--brand-primary,#0ea5a4);
    --bs-btn-hover-color:#fff; --bs-btn-hover-bg:#0c8f8e; --bs-btn-hover-border-color:#0c8f8e;
  }
</style>

<div class="container py-4">
  <div class="card card-shell">
    <!-- Header -->
    <div class="card-header-brand">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <h5 class="mb-0"><i class="fa-solid fa-books me-2"></i> Manage Books</h5>
        <div class="ms-auto d-flex flex-wrap gap-2">
          <a href="{% url 'addbook' %}" class="btn btn-brand btn-sm">
            <i class="fa-solid fa-circle-plus me-1"></i> Add Book
          </a>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card-body">
      <div class="row g-3 align-items-center justify-content-between mb-3">
        <div class="col-12 col-md-auto">
          <div class="input-group input-group-sm search-wrap" style="min-width:260px;">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="tableSearch" type="text" class="form-control" placeholder="Search by name, ISBN, author, categoryâ€¦">
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table id="booksTable" class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:80px;">S.No.</th>
              <th>Book Name</th>
              <th>ISBN</th>
              <th>Author Name</th>
              <th>Category</th>
              <th style="width:120px;">Quantity</th>
              <th style="width:160px;">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for i in data %}
            <tr>
              <td class="text-center">{{ forloop.counter }}</td>
              <td class="fw-semibold">{{ i.book_name }}</td>
              <td>{{ i.isbn }}</td>
              <td>{{ i.author }}</td>
              <td><span class="badge rounded-pill" style="background:rgba(14,165,164,.12); color:#0ea5a4; border:1px solid rgba(14,165,164,.35);">{{ i.category }}</span></td>
              <td class="text-center">{{ i.quantity }}</td>
              <td class="text-center">
                <a href="{% url 'editbook' i.id %}" class="btn btn-sm btn-secondary me-1">
                  <i class="fa-solid fa-pen-to-square"></i> Edit
                </a>
                <a href="{% url 'deletebook' i.id %}" class="btn btn-sm btn-danger confirm-delete" data-delete-url="{% url 'deletebook' i.id %}">
                  <i class="fa-solid fa-trash"></i> Delete
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4 text-muted">
                <i class="fa-regular fa-face-frown me-1"></i> No books found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Toasts & Delete confirm -->
<script>
  // SweetAlert2 toasts for add/delete/update (replaces alert())
  (function(){
    const Toast = Swal.mixin({
      toast:true, position:'top-end', showConfirmButton:false, timer:2200, timerProgressBar:true
    });

    {% if error3 %}
      Toast.fire({ icon:'success', title:'Book added successfully' });
    {% endif %}
    {% if error1 %}
      Toast.fire({ icon:'success', title:'Book deleted successfully' });
    {% endif %}
    {% if error %}
      Toast.fire({ icon:'success', title:'Book updated successfully' });
    {% endif %}
  })();

  // Client-side search (book, isbn, author, category)
  (function(){
    const input = document.getElementById('tableSearch');
    const table = document.getElementById('booksTable');
    if(!input || !table) return;

    input.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cols = Array.from(row.cells).slice(1, 5); // Book, ISBN, Author, Category
        const hit = cols.some(td => (td.textContent || '').toLowerCase().includes(q));
        row.style.display = hit ? '' : 'none';
      });
    });
  })();

  // Confirm before delete
  (function(){
    document.querySelectorAll('.confirm-delete').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const url = this.getAttribute('data-delete-url') || this.getAttribute('href');
        Swal.fire({
          icon:'warning',
          title:'Delete this book?',
          text:'This action cannot be undone.',
          showCancelButton:true,
          confirmButtonText:'Yes, delete',
          cancelButtonText:'Cancel'
        }).then(res => {
          if(res.isConfirmed){ window.location.href = url; }
        });
      });
    });
  })();
</script>
{% endblock %}
